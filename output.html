<h1>Elaina — MoonBit Markdown 解析器</h1>
<p>将 Markdown 文本解析为 HTML 的轻量级解析器与渲染器，使用 MoonBit 编写。</p>
<h2>✨ 特性</h2>
<ul>
  <li>标题规则：仅当 <code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">#</code> 后有空格时才识别为标题（如 <code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">#Title</code> 视为普通文本）</li>
  <li>行内代码：支持反引号包裹的行内代码，内容严格 HTML 转义，并以 <code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">&lt;code&gt;</code> 加浅色背景渲染</li>
  <li>围栏代码块：
<ul>
  <li>支持前置缩进</li>
  <li>记录开栏反引号数量，闭栏需满足“长度 ≥ 开栏长度”，允许内层更短的反引号出现在代码内</li>
  <li>首行余部作为语言标识，渲染为 <code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">&lt;pre&gt;&lt;code class=&quot;language-...&quot;&gt;</code></li>
  <li>额外提供带背景与“复制”按钮的容器（内置 Clipboard 调用）</li>
</ul>
</li>
  <li>列表：
<ul>
  <li>支持无序（<code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">-</code>/<code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">*</code>）与有序（数字+<code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">.</code>）</li>
  <li>有序列表在代码块或空行之后继续编号，不会重置</li>
  <li>ListItem 支持嵌套子块（段落、引用、列表、围栏代码等），可表达多层级结构</li>
</ul>
</li>
  <li>引用（blockquote）：语义化 <code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">&lt;blockquote&gt;</code>，内部可包含段落/列表/代码块等子内容</li>
  <li>文本安全：对 <code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">&amp;</code>、<code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">&lt;</code>、<code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">&gt;</code>、<code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">&quot;</code>、<code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">&#39;</code> 等字符进行 HTML 转义</li>
</ul>
<blockquote>
<p>说明：行内强调/加粗/链接/图片等高级行内语法仍在规划中，后续会逐步完善。</p>
</blockquote>
<h2>📦 项目结构</h2>
<div class="code-block" style="position:relative;background:#f6f8fa;border-radius:6px;">
<button class="copy-button" style="position:absolute;top:8px;right:8px;padding:4px 8px;font-size:12px;cursor:pointer;" onclick="(function(btn){var code=btn.parentElement.querySelector('code');navigator.clipboard.writeText(code.innerText).then(function(){btn.textContent='Copied';setTimeout(function(){btn.textContent='Copy'},1500)})})(this)">Copy</button>
<pre style="margin:0;padding:12px 16px;overflow:auto;"><code>src/
    ast.mbt         # AST 定义（Text / Block 等）
    tokenizer.mbt   # 词法分析：把字符流切分为 Token
    parser.mbt      # 语法分析：把 Token 流构建为 Block 列表（含列表/引用/围栏等）
    renderer.mbt    # 渲染：把 Block 渲染为 HTML（含 UTF-8 版本与完整页面、复制按钮）</code></pre>
</div>
<h2>🚀 快速开始</h2>
<p>前置：已安装 MoonBit 工具链（参考 MoonBit 官方文档）。</p>
<ol>
  <li>运行示例入口（读取仓库根目录的 <code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">README.md</code>，在同目录生成 <code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">output.html</code>）：
<div class="code-block" style="position:relative;background:#f6f8fa;border-radius:6px;">
<button class="copy-button" style="position:absolute;top:8px;right:8px;padding:4px 8px;font-size:12px;cursor:pointer;" onclick="(function(btn){var code=btn.parentElement.querySelector('code');navigator.clipboard.writeText(code.innerText).then(function(){btn.textContent='Copied';setTimeout(function(){btn.textContent='Copy'},1500)})})(this)">Copy</button>
<pre style="margin:0;padding:12px 16px;overflow:auto;"><code class="language-powershell">    moon run ./src/main.mbt</code></pre>
</div>
</li>
  <li>打开生成的 <code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">output.html</code> 查看 HTML 渲染结果。</li>
</ol>
<blockquote>
<p>备注：项目使用 <code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">fs</code> 写文件，无需 PowerShell 的 <code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">&gt;</code> 重定向，避免编码问题。</p>
</blockquote>
<h2>🛠️ 自定义输入/输出路径</h2>
<p><code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">src/main.mbt</code> 中示例默认：</p>
<div class="code-block" style="position:relative;background:#f6f8fa;border-radius:6px;">
<button class="copy-button" style="position:absolute;top:8px;right:8px;padding:4px 8px;font-size:12px;cursor:pointer;" onclick="(function(btn){var code=btn.parentElement.querySelector('code');navigator.clipboard.writeText(code.innerText).then(function(){btn.textContent='Copied';setTimeout(function(){btn.textContent='Copy'},1500)})})(this)">Copy</button>
<pre style="margin:0;padding:12px 16px;overflow:auto;"><code class="language-moonbit">let context = @fs.read_file_to_string(&quot;./README.md&quot;)
@fs.write_string_to_file(&quot;./output.html&quot;, html)</code></pre>
</div>
<p>按需修改为你的 Markdown 路径与输出路径即可。</p>
<p>如需生成带 <code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">&lt;head&gt;</code> 与 UTF‑8 meta 的完整 HTML 页面，使用 <code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">render_html_page</code>：</p>
<div class="code-block" style="position:relative;background:#f6f8fa;border-radius:6px;">
<button class="copy-button" style="position:absolute;top:8px;right:8px;padding:4px 8px;font-size:12px;cursor:pointer;" onclick="(function(btn){var code=btn.parentElement.querySelector('code');navigator.clipboard.writeText(code.innerText).then(function(){btn.textContent='Copied';setTimeout(function(){btn.textContent='Copy'},1500)})})(this)">Copy</button>
<pre style="margin:0;padding:12px 16px;overflow:auto;"><code class="language-moonbit">let (page, err) = render_html_page(context)
@fs.write_string_to_file(&quot;./output.html&quot;, page)</code></pre>
</div>
<h2>📚 API 速览</h2>
<p>所有渲染入口均返回 <code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">(String, String?)</code>，第二个值为可选错误信息：</p>
<ul>
  <li><code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">render_html(input)</code>：渲染为 HTML 片段（仅 <code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">&lt;body&gt;</code> 内容）</li>
  <li><code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">render_html_utf8(input)</code>：UTF‑8 直出版（对特殊字符转义，中文直出）</li>
  <li><code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">render_html_page(input)</code>：完整 HTML 文档（含 <code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">&lt;meta charset=&quot;utf-8&quot;&gt;</code>）</li>
  <li><code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">render_html_from_utf8_bytes_lossy(bytes)</code>：从 UTF‑8 字节视图宽松解码后渲染</li>
</ul>
<p>示例：</p>
<div class="code-block" style="position:relative;background:#f6f8fa;border-radius:6px;">
<button class="copy-button" style="position:absolute;top:8px;right:8px;padding:4px 8px;font-size:12px;cursor:pointer;" onclick="(function(btn){var code=btn.parentElement.querySelector('code');navigator.clipboard.writeText(code.innerText).then(function(){btn.textContent='Copied';setTimeout(function(){btn.textContent='Copy'},1500)})})(this)">Copy</button>
<pre style="margin:0;padding:12px 16px;overflow:auto;"><code class="language-moonbit">let md = &quot;# 标题nn这是一个段落n&quot;
let (html, err) = render_html(md)
match err {
    None =&gt; println(html)
    Some(e) =&gt; println(e)
}</code></pre>
</div>
<h2>🧪 测试与格式化</h2>
<div class="code-block" style="position:relative;background:#f6f8fa;border-radius:6px;">
<button class="copy-button" style="position:absolute;top:8px;right:8px;padding:4px 8px;font-size:12px;cursor:pointer;" onclick="(function(btn){var code=btn.parentElement.querySelector('code');navigator.clipboard.writeText(code.innerText).then(function(){btn.textContent='Copied';setTimeout(function(){btn.textContent='Copy'},1500)})})(this)">Copy</button>
<pre style="margin:0;padding:12px 16px;overflow:auto;"><code class="language-powershell">moon test         # 运行测试（包含解析与渲染的快照/断言）
moon info         # 更新接口快照（.mbti），便于检查 API 变化
moon fmt          # 格式化代码</code></pre>
</div>
<p>当你确实更改了输出快照（例如渲染 HTML 的结构/样式变化），可使用：</p>
<div class="code-block" style="position:relative;background:#f6f8fa;border-radius:6px;">
<button class="copy-button" style="position:absolute;top:8px;right:8px;padding:4px 8px;font-size:12px;cursor:pointer;" onclick="(function(btn){var code=btn.parentElement.querySelector('code');navigator.clipboard.writeText(code.innerText).then(function(){btn.textContent='Copied';setTimeout(function(){btn.textContent='Copy'},1500)})})(this)">Copy</button>
<pre style="margin:0;padding:12px 16px;overflow:auto;"><code class="language-powershell">moon test --update</code></pre>
</div>
<h2>🧠 设计概览</h2>
<ul>
  <li>Tokenizer：聚合连续普通字符为 <code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">Text</code>，识别 <code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">#</code>、<code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">*</code>、 <code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;"> </code><code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">、</code>[<code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">、</code>]<code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">、</code>(<code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">、</code>)<code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">、</code>!<code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">、</code>&gt;<code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">、</code>-<code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">、</code>. 等标记；兼容 CRLF/LF</li>
  <li>Parser：
<ul>
  <li>标题：行首 <code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">#</code>×N + 空格 + 文本</li>
  <li>围栏代码块：支持前置缩进与“闭栏长度 ≥ 开栏长度”的匹配；首行余部作为语言标识</li>
  <li>列表：无序/有序，允许空行与子块（段落/引用/列表/围栏）作为 ListItem 嵌套内容；有序列表编号跨子块/空行不重置</li>
  <li>引用：解析为携带子块的 BlockQuote</li>
  <li>段落：连续非空行合并，换行为 <code class="inline-code" style="background:#f6f8fa;padding:0 .25em;border-radius:4px;">&lt;br/&gt;</code></li>
</ul>
</li>
  <li>Renderer：普通版与 UTF‑8 直出版；代码块容器含背景与复制按钮，列表/引用/嵌套子块递归渲染</li>
</ul>
<h2>🗺️ 路线图</h2>
<ul>
  <li>行内语法：强调、加粗、链接、图片等</li>
  <li>水平分割线、表格、自动链接/GFM 任务列表</li>
  <li>更丰富的错误诊断与位置报告</li>
</ul>
